---
title: "Astrocyte_AB.Rmd"
output: html_document
date: "2024-03-04"
---
```{r}
deseq2_root <- "/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/DESEQ2/"
gsea_root <- "/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/GSEA/"
if(!file.exists(gsea_root)) {
      dir.create(gsea_root, mode="0755", recursive=TRUE)
    }

deseq2_conf_liststr <- "Degrade_33_8vs24hr,Degrade_33_8vs48hr,Degrade_33vs44_24hr,Degrade_33vs44_48hr,Degrade_44_8vs24hr,Degrade_44_8vs48hr,Uptake_33_AbvsCtrl,Uptake_33vs44_Ab,Uptake_33vs44_Ctrl,Uptake_44_AbvsCtrl"

deseq2_conf_list <- unlist(strsplit(deseq2_conf_liststr, ","))

gmt_dir <- "/projectnb/tcwlab/MSigDB/"
```
Initial GSEA
```{r}
#BiocManager::install('fgsea', lib = library_path)
library(fgsea)

#Takes file index in the deseq2_conf_liststr
run_gsea <- function(x){
  comparison <- deseq2_conf_list[x]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "Results_GTFAnnotated_NoGeneIDDuplicates.csv"))
  
  #Rank data frame by stat
  df_sorted <- df[order(df$stat),]
  ranks <- setNames(df_sorted$stat, df_sorted$gene_name)
  
  for (i in 1:nrow(pathway_df)) {
    pathways <- gmtPathways(paste0(gmt_dir, pathway_df$gmt[i]))
  
    #GSEA
    fgseaRes <- fgsea(pathways, ranks, scoreType='std',nPermSimple = 10000)
    
    #Not including the leading edges
    gsea_stat <- fgseaRes[, -8]
    
    #Leading edges
    gsea_genes <- data.frame(leadingEdge = sapply(fgseaRes$leadingEdge, paste, collapse = ","))
    rownames(gsea_genes) <- fgseaRes$pathway
    
    #Pathways
    topPathwaysUp <- fgseaRes[NES > 0][head(order(pval), n=10), pathway]
    topPathwaysDown <- fgseaRes[NES < 0][head(order(pval), n=10), pathway]
    topPathways <- c(topPathwaysUp, rev(topPathwaysDown))
    
    gsea_subdir <- paste0(gsea_root, comparison, "/")
    if(!file.exists(gsea_subdir)) {
        dir.create(gsea_subdir, mode="0755", recursive=TRUE)
    }
    
    #Name each GSEA result by the comparison name
    gsea_stats_filename <- paste0(gsea_subdir, comparison, "_", pathway_df$gmt[i], "_stats.csv")
    gsea_genes_filename <- paste0(gsea_subdir, comparison, "_", pathway_df$gmt[i], "_leadingedges.csv")
    gsea_pathway_filename <- paste0(gsea_subdir, comparison, "_", pathway_df$gmt[i], "_pathways.csv")
    
    #Save the data frame
    write.csv(as.data.frame(gsea_stat), gsea_stats_filename, row.names = FALSE, quote = FALSE)
    write.csv(gsea_genes, gsea_genes_filename)
    write.csv(topPathways, gsea_pathway_filename)
  }
}

#Define pathways of interest
pathway_df <- data.frame(
      name=c("GO_all", "C2_CP"),
      gmt=c("c5.go.v2023.1.Hs.symbols.gmt","c2.cp.v2023.1.Hs.symbols.gmt"),
      desc=c("GO All" ,"C2 CP"),
      category=c("C5", "C2"))


#Two-way plot for uptake experiment
for (i in 1:10) {
  run_gsea(i)
}
```
GSEA Pathway Visualizatiion
```{r}
library(ggplot2)

pathway_df_all <- data.frame()

for (i in 1:10) {
  comparison <- deseq2_conf_list[i]
  for (j in 1:nrow(pathway_df)) {
    pathway_res <- paste0(gsea_root, comparison, "/", comparison, "_", pathway_df$gmt[j], "_stats.csv")
    df <- read.csv(pathway_res)
    df_sorted <- df[order(df$NES), ]
    top_neg_pathway <- head(df_sorted, 10)
    top_pos_pathway <- tail(df_sorted, 10)
  
    top_pathways <- rbind(top_neg_pathway, top_pos_pathway)
    top_pathways[, 8] <- pathway_df$name[j]
    top_pathways[, 9] <- deseq2_conf_list[i]
    
    #Get a single data frame that contains all top pathways from all comparisons
    pathway_df_all <- rbind(pathway_df_all, top_pathways)
    
    #Pathway visualization
    outdir <- '/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/Pathway/'
    
    plot_dir <- paste0(outdir, comparison, "/", pathway_df$gmt[j], "/")
    if(!file.exists(plot_dir)) {
        dir.create(plot_dir, mode="0755", recursive=TRUE)
    }
    
    #Bar plot
    bar <- ggplot(top_pathways, aes(x = NES, y = pathway, fill = -log10(padj))) +
      geom_col() +
      scale_fill_gradientn(colors = c("blue", "red")) +
      theme(panel.margin=unit(.05, "lines"),  panel.border = element_rect(color = "black", fill = NA, linewidth = 1)) +
      labs(title = comparison, x = "", y = "Pathway")

    #Save as pdf
    pdf(paste0(plot_dir, comparison, "_", pathway_df$gmt[j], "_bar_plot.pdf"), height = 10, width = 10)
    print(bar)
    dev.off()
    
    #Dotplot
    dot <- ggplot(top_pathways, aes(x=NES, y=pathway, colour=padj, size=size)) +
      geom_point() +
      expand_limits(x=0) +
      labs(title = comparison, x="NES", y="GO term", colour="p_adj", size="Count")
  
    #Save as pdf
    pdf(paste0(plot_dir, comparison, "_", pathway_df$gmt[j], "_dot_plot.pdf"), height = 10, width = 10)
    print(dot)
    dev.off()
  }
}

colnames(pathway_df_all)[8] <- "Pathway"
colnames(pathway_df_all)[9] <- "Comparison"

#Example
tmp <- pathway_df_all[pathway_df_all$Comparison == "Degrade_33_8vs24hr", ]

head(pathway_df_all)
```
Emma Polt Function
```{r}
library(stringr)
require(igraph)
require(ggraph)

LeadingEdges<-function(res_fgsea){
  if(all(c('term','n.overlap','genes.overlap')%in%colnames(res_fgsea))){
    l_genes<-str_extract_all(res_fgsea$genes.overlap,'[A-Za-z0-9]+')
    l_genes<-lapply(l_genes, function(x)x[x!='c'])
    names(l_genes)<-res_fgsea$pathway
    return(l_genes)
    
  }else{
    l_genes<-str_extract_all(res_fgsea$leadingEdge,'[A-Za-z0-9]+')
    l_genes<-lapply(l_genes, function(x)x[x!='c'])
    names(l_genes)<-res_fgsea$pathway
    return(l_genes)
  }
  
 
}

overlap_ratio <- function(x, y) {
  x <- unlist(x)
  y <- unlist(y)
  length(intersect(x, y))/length(unique(c(x,y)))
}

get_similarity_matrix <- function(leading_edge_list) {
  
  n <- length(leading_edge_list)
  ids<-names(leading_edge_list)
  w <- matrix(NA, nrow=n, ncol=n)
  colnames(w) <- rownames(w) <- names(leading_edge_list)
  
  for (i in seq_len(n-1)) {
    for (j in (i+1):n) {
      w[i,j] <- overlap_ratio(leading_edge_list[ids[i]], leading_edge_list[ids[j]])
    }
  }
  return(w)
}


# get graph of sim
get_igraph <- function(res_fgsea, simmat,leading_edge_list,
                       pathway_names, col.var, min_edge) {
  if(any(duplicated(res_fgsea$pathway)))stop('error: duplicated pathways')
  
  wd <- reshape2::melt(simmat[pathway_names,pathway_names])
  wd <- wd[wd[,1] != wd[,2],]
  # remove NA
  wd <- wd[!is.na(wd[,3]),]
  
  g <- graph.data.frame(wd[, -3], directed=FALSE)
  E(g)$width <- sqrt(wd[, 3] * 5) 
  
  
  
  # Use similarity as the weight(length) of an edge
  E(g)$weight <- wd[, 3]
  g <- delete.edges(g, E(g)[wd[, 3] < min_edge])
  
  res_fgseaf<-res_fgsea[V(g)$name,on='pathway']
  #idx <- unlist(sapply(V(g)$name, function(x) which(x == res_fgseaf$pathway)))
  cnt <- sapply(leading_edge_list, length)
  
  V(g)$size <- cnt[V(g)$name]
  
  colVar <- as.numeric(as.vector(res_fgseaf[V(g)$name, on='pathway'][,.SD,.SDcols=col.var][[1]]))
  
  V(g)$colvar <- colVar
  
  return(g)
}


#plot the graphs
add_category_nodes <- function(p,col.var,cols=cols) {
  locol=cols[1]
  midcol=ifelse(length(cols==3),cols[2],NULL)
  hicol=cols[-1]
  
  p<-p + ggnewscale::new_scale_fill() +geom_point(shape = 21, aes_(x =~ x, y =~ y, fill =~ colvar,
                                                                   size =~ size)) +
    scale_size_continuous(name = "number of genes",
                          range = c(3, 8) )
  
  if(!is.null(midcol))p<-p+scale_fill_gradient2(low = locol,mid=midcol, high = hicol,name=col.var,
                                                guide = guide_colorbar()) 
  else p<-p+scale_fill_continuous(low = locol, high = hicol,name=col.var,
                                  guide = guide_colorbar())
  
  p<-p+theme(legend.title = element_text(size = 10),
             legend.text  = element_text(size = 10)) +
    theme(panel.background = element_blank()) 
  return(p)
}
add_node_label <- function(p,label.size=label.size,max.overlaps=10) {
  
  p <- p + geom_node_text(aes_(label=~name),
                          size = label.size, repel=TRUE,
                          max.overlaps=max.overlaps)
  
  return(p)
}

#Emmaplot (Alexandre's code)
emmaplot<-function(res_fgsea,
                   pathway_names=NULL, 
                   col.var="NES",
                   show_pathway_of=NULL,
                   min_edge=0.2,
                   label.size=2.5,
                   cols=c('blue','white','red'),
                   max.overlaps=10){
  require('ggrepel')
  
  if(all(c('term','n.overlap')%in%colnames(res_fgsea))){
    res_fgsea[,pathway:=term]
    res_fgsea[,NES:=fold.enrichment]
    
  }
  
  if(is.null(pathway_names))pathway_names=res_fgsea[order(pval)]$pathway
  
  lelist<-LeadingEdges(res_fgsea[pathway%in%pathway_names])
  
  if(!is.null(show_pathway_of)){
    
    lelist<-lelist[sapply(lelist, function(leadingedges)any(show_pathway_of%in%leadingedges))]
    if(length(lelist)>0){
      pathway_names<-names(lelist)
      
    }else{
      stop('This gene are not found in any leading edges of the given pathways')
    }
  }
  
  if(length(lelist)>1){
    
    simat<-get_similarity_matrix(lelist)
    
    g <- get_igraph(res_fgsea = res_fgsea,
                    pathway_names = pathway_names,
                    simmat = simat,
                    leading_edge_list = lelist,
                    min_edge = min_edge,
                    col.var = col.var
    )
    
    
    p <- ggraph(g, layout='nicely')
    
    p <- p + geom_edge_link(alpha=.8, aes_(width=~I(width)),
                            colour='darkgrey')
    ## add dot
    p <- add_category_nodes(p = p,col.var =col.var,cols=cols)
    
    ## add node label
    
    p <- add_node_label(p = p,label.size=label.size,max.overlaps=max.overlaps)
    
  }else{
    p <- ggplot(res_fgsea[pathway%in%pathway_names][,x:=1][,y:=1],aes_string(x='x',y='x'))+
      geom_point(aes_string(size='size',col=col.var))+
      geom_text_repel(aes(label=pathway))+
      scale_color_gradient2(low = cols[1],high = cols[max(1:length(cols))],midpoint = 0,limits=c(-abs(as.numeric(as.vector(res_fgsea[pathway%in%pathway_names][,..col.var]))),
                                                                                                 abs(as.numeric(as.vector(res_fgsea[pathway%in%pathway_names][,..col.var])))))+
      theme_graph()
    
  }
  
  
  if(!is.null(show_pathway_of)){
    if(length(show_pathway_of)>1){
      return(p+ggtitle(paste('Enriched pathways for selected genes')))
      
    }else{
      return(p+ggtitle(paste('Enriched pathways with', show_pathway_of)))
      
    }
    
  }else{
    return(p)
    
  }
}
```
Run Emma
```{r}
run_emma <- function(x){
  comparison <- deseq2_conf_list[x]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "Results_GTFAnnotated_NoGeneIDDuplicates.csv"))
  
  outdir <- '/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/Pathway/'
  
  #Rank data frame by stat
  df_sorted <- df[order(df$stat),]
  ranks <- setNames(df_sorted$stat, df_sorted$gene_name)
  
  for (i in 1:nrow(pathway_df)) {
    pathways <- gmtPathways(paste0(gmt_dir, pathway_df$gmt[i]))
  
    #GSEA
    fgseaRes <- fgsea(pathways, ranks, scoreType='std',nPermSimple = 10000)
    
    #Top 40 pathways in either directions
    activated <- head(fgseaRes[order(fgseaRes$NES, decreasing = TRUE), ], 40)
    suppressed <- head(fgseaRes[order(fgseaRes$NES, decreasing = FALSE), ], 40)
    
    top_pathways <- data.frame()
    top_pathways <- rbind(activated, suppressed)
    
    emma <- emmaplot(top_pathways, label.size = 1.5)
    
    emma_dir <- paste0(outdir, comparison, "/", pathway_df$gmt[i], "/")
    if(!file.exists(emma_dir)) {
        dir.create(emma_dir, mode="0755", recursive=TRUE)
    }

    #Save as pdf
    ggsave(paste0(emma_dir, comparison, "_", pathway_df$gmt[i], "_emma_plot.pdf"), height = 10, width = 10)
  }
}

for (i in 1:10) {
  run_emma(i)
}


#Example
df <- read.csv("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/DESEQ2/Degrade_33_8vs24hr/33(8vs24hr)/Results_GTFAnnotated_NoGeneIDDuplicates.csv")

#Rank data frame by stat
df_sorted <- df[order(df$stat),]
ranks <- setNames(df_sorted$stat, df_sorted$gene_name)
pathways <- gmtPathways(paste0(gmt_dir, pathway_df$gmt[1]))
fgseaRes <- fgsea(pathways, ranks, scoreType='std',nPermSimple = 10000)

activated <- head(fgseaRes[order(fgseaRes$NES, decreasing = TRUE), ], 40)
suppressed <- head(fgseaRes[order(fgseaRes$NES, decreasing = FALSE), ], 40)

top_pathways <- data.frame()
top_pathways <- rbind(activated, suppressed)

test <- emmaplot(top_pathways, label.size = 1.5)
ggsave("test.pdf", height = 10, width = 10)
#emmaplot(res_fgsea_top,show_pathway_of = 'CDK2')
```
Visualization with ClusterProfiler
```{r}
#Pathway Visualization with ClusterProfile

library_path <- "/projectnb/tcwlab/LabMember/mwu/R/"

#BiocManager::install('yulab.utils', lib = library_path)
#BiocManager::install('ggtree', lib = library_path)
#BiocManager::install("shadowtext", lib = library_path)
#BiocManager::install("clusterProfiler", lib = library_path)
#BiocManager::install("pathview", lib = library_path)
#BiocManager::install("enrichplot", lib = library_path)
library(clusterProfiler, lib = library_path)
library(enrichplot, lib = library_path)

#Genome-wide annotation on Bioconductor ("https://bioconductor.org/packages/release/BiocViews.html#___OrgDb)
organism = "org.Hs.eg.db"
#BiocManager::install(organism, character.only = TRUE)
library(organism, character.only = TRUE)


pathway_vis <- function(x) {
  comparison <- deseq2_conf_list[i]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "Results_GTFAnnotated_NoGeneIDDuplicates.csv"))
  
  outdir <- '/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/Pathway/'
  
  #Obtain log2FC rank
  gene_list <- df$log2FoldChange
  names(gene_list) <- df$gene_name
  gene_list <- sort(gene_list, decreasing = TRUE)
  
  gse <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "SYMBOL", 
             nPerm = 10000, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = organism, 
             pAdjustMethod = "none")

  
  #Dotplot for top 10 enriched pathways
  dotplot_dir <- paste0("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/Pathway/", comparison, "/")
  if(!file.exists(dotplot_dir)) {
        dir.create(dotplot_dir, mode="0755", recursive=TRUE)
  }
  
  dot <- dotplot(gse, showCategory=10, split=".sign") + facet_grid(.~.sign) + ggtitle(paste0(comparison, " Dotplot"))

  #Save as pdf
  pdf(paste0(dotplot_dir, comparison, "_Dot_plot.pdf"), height = 10, width = 10)
  print(dot)
  dev.off()
  
  #Emma Plot for top 10 enriched pathways
  emma_dir <- paste0("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/Pathway/", comparison, "/")
  if(!file.exists(emma_dir)) {
        dir.create(emma_dir, mode="0755", recursive=TRUE)
  }
  
  emma <- emapplot(gse, showCategory = 10) + ggtitle(paste0(comparison, " Emmaplot"))
  
  #Save as pdf
  pdf(paste0(emma_dir, comparison, "_Emma_plot.pdf"), height = 10, width = 10)
  print(emma)
  dev.off()
}

#Takes file index in the deseq2_conf_liststr
for (i in 1:10) {
  pathway_vis(i)
}

#Example
df <- read.csv("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/DESEQ2/Degrade_33_8vs24hr/33(8vs24hr)/Results_GTFAnnotated_NoGeneIDDuplicates.csv")

gene_list <- df$log2FoldChange
names(gene_list) <- df$gene_name
gene_list <- sort(gene_list, decreasing = TRUE)
  
gse <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "SYMBOL", 
             nPerm = 10000, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = organism, 
             pAdjustMethod = "none")


# Treeplot that calculates pairwise similarities of the enriched terms using Jaccardâ€™s similarity index
require(DOSE)
dotplot(gse, showCategory=10, split=".sign") + facet_grid(.~.sign)
```
Table for pathway overlap
```{r}
# Find pathways that are overlapped between comparisons

uptake_subset <- pathway_df_all[pathway_df_all$Comparison == deseq2_conf_list[7:10], ]

uptake_duplicated_pathway <- uptake_subset[duplicated(uptake_subset$pathway) | duplicated(uptake_subset$pathway, fromLast = TRUE), ]

uptake_duplicated_pathway_sorted <- uptake_duplicated_pathway[order(uptake_duplicated_pathway$pathway, uptake_duplicated_pathway$Comparison), ]

write.csv(uptake_duplicated_pathway_sorted, "/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/GSEA/Overlapped Pathways in Astrocyte Amyloid Uptake.csv")

degrade_subset <- pathway_df_all[pathway_df_all$Comparison == deseq2_conf_list[1:6], ]

degrade_duplicated_pathway <- degrade_subset[duplicated(degrade_subset$pathway) | duplicated(degrade_subset$pathway, fromLast = TRUE), ]

degrade_duplicated_pathway_sorted <- degrade_duplicated_pathway[order(degrade_duplicated_pathway$pathway), ]

#write.csv(degrade_duplicated_pathway_sorted, "/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/GSEA/Overlapped Pathways in Astrocyte Amyloid Degrade.csv")
```
Volcano Plot
```{r}
#Volcano Plot
#BiocManager::install("EnhancedVolcano")
library(EnhancedVolcano)

#Takes data frame and plot title
volcano <- function(df, title){
  p <- EnhancedVolcano(df,
  lab = df$gene_name,
  x = 'log2FoldChange',
  y = 'pvalue',
  title = title,
  pointSize = c(ifelse(df$log2FoldChange>3, 3, 1)),
  pCutoff = 0.1 ,
  FCcutoff = 0.5,
  cutoffLineType = 'twodash',
  cutoffLineCol = 'black',
  cutoffLineWidth = 0.8,
  hline = c(0.1, 1e-10),
  hlineCol = 'black',
  hlineType = 'longdash',
  hlineWidth = 1,
  gridlines.major = FALSE,
  gridlines.minor = FALSE,
  legendLabels=c('Not sig.','Log (base 2) FC','p-value', 'p-value & Log (base 2) FC'),
  legendPosition = "right",
  legendLabSize = 12,
  legendIconSize = 5.0,
  caption = bquote(~Log[2]~ "fold change cutoff, 0.5; p-value cutoff, 0.1"))
}

for (i in 1:10) {
  comparison <- deseq2_conf_list[i]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "Results_GTFAnnotated_NoGeneIDDuplicates.csv"))

  filename <- paste0("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/volcano_plot", comparison, "_Volcano Plot.pdf")
  pdf(filename, height = 10, width = 10)
  print(volcano(df, comparison))
  dev.off()
}

```
Heatmap
```{r}
#Heat map
library(tidyr)
library(dplyr)
library(pheatmap)
library(ComplexHeatmap)
library(RColorBrewer)

#Takes comparison files number, plot height and plot width
make_heatmap <- function(files, height, width) {
  gene_df_all <- data.frame()
  gene_df_temp <- data.frame()
  gene_df_comp <- data.frame()
  for (i in files) {
  comparison <- deseq2_conf_list[i]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "Results_GTFAnnotated_NoGeneIDDuplicates.csv"))
  df[, 34] <- comparison
  colnames(df)[34] <- "Comparison"
  
  #Contains genes from all the comparisons
  gene_df_all <- rbind(gene_df_all, df)
  colnames(gene_df_all)[34] <- "Comparison"
  
  # Top 5 genes with logFC in both directions in each comparison
  df_sorted <- df[order(df$log2FoldChange), ]
  top_genes <- rbind(head(df_sorted, 5), tail(df_sorted, 5))
  
  #Get genes that are in all comparisons
  gene_df_comp <- rbind(gene_df_comp, gene_df_all[gene_df_all$Comparison %in% deseq2_conf_list[files] & gene_df_all$gene_name %in% top_genes$gene_name, ])

} #End making gene_df_comp for all comparisons
  
  #Extract columns: Log2FC, Gene_name, and Comparison
  temp <- gene_df_comp[, c(3, 19, 34)]
  
  #Remove duplicated rows for each comparison, which are fine to remove since they are potential repeated genes obtained when making the gene_df_comp
  distinct_df <- temp %>% distinct(gene_name, Comparison, .keep_all = TRUE)
  
  #Transform data
  pivoted_df <- pivot_wider(distinct_df, names_from = Comparison, values_from = log2FoldChange)

  #Replace missing values with zeros
  pivoted_df[is.na(pivoted_df)] <- 0
  
  #Transform into matrix
  df_matrix <- as.matrix(pivoted_df[, -1])
  
  #Assign row names and col names
  rownames(df_matrix) <- pivoted_df$gene_name
  colnames(df_matrix) <- c("33 vs 44 24hr", "33 vs 44 48hr")

  #Make heatmap
  coul <- colorRampPalette(brewer.pal(8, "PiYG"))(25)
                                                  
  ComplexHeatmap::pheatmap(df_matrix, cluster_cols = FALSE, cluster_rows = FALSE, color = hcl.colors(50, "BluYl"), heatmap_legend_param = list(title = "log2FC"), angle_col = "315", cellheight=height, cellwidth = width)
}

make_heatmap(c(3,4), 12, 25)
```
PCA
```{r}
#PCA
library(tidyverse)
#BiocManager::install("ggfortify")
library(ggfortify)
library(biomaRt)

#Takes file index in the deseq2_conf_liststr
make_pca <- function(x){
  comparison <- deseq2_conf_list[x]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "deseq2_normalized_counts.csv"))
  
  #Assign genes as rownames
  rownames(df) <- df[, 1]
  
  matrix_data <- as.matrix(df[, -1])
  
  # Perform the PCA
  pca_result <- prcomp(t(matrix_data))
  
  pc_eigenvalues <- pca_result$sdev^2
  
  pc_eigenvalues <- tibble(PC = factor(1:length(pc_eigenvalues)), variance = pc_eigenvalues) %>% 
    #Percent variance
    mutate(pct = variance/sum(variance)*100) %>% 
    #Cumulative variance explained
    mutate(pct_cum = cumsum(pct))
  
  #Percentage explained by PC Visualization
  prct_pc <- pc_eigenvalues %>% 
    ggplot(aes(x = PC)) +
    geom_col(aes(y = pct)) +
    geom_line(aes(y = pct_cum, group = 1)) + 
    geom_point(aes(y = pct_cum)) +
    labs(x = "Principal component", y = "Percent variance explained", title = paste0(comparison, " Top PCs"))
  
  output_subdir <- paste0("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/PCA/", comparison, "/")
    if(!file.exists(output_subdir)) {
        dir.create(output_subdir, mode="0755", recursive=TRUE)
    }
  
  #PC file name
  plot1 <- paste0(output_subdir, comparison, "_", "PC_percentage.pdf")
  
  #Save as pdf
  ggsave(plot1, plot = prct_pc, height = 10, width = 10)

  #Shorten the sample name to fit the label
  substrings_to_replace <- c("TCW", "\\.Ast")
  for (i in substrings_to_replace) {
    row.names(pca_result$x) <- gsub(i, "", row.names(pca_result$x))
  }
  
  #Get PC scores
  pc_scores <- as_tibble(pca_result$x, rownames = "Sample")
  
  #Sample Cluster Visualization
  pca_plot <- autoplot(pca_result, data = pc_scores, colour = 'Sample')
  
  #PCA Cluster file name
  plot2 <- paste0(output_subdir, comparison, "_", "PCA_cluster.pdf")
  
  #Save as pdf
  pdf(plot2, height = 10, width = 10)
  print(pca_plot)
  dev.off()
  
  #Get PC dimensions
  pc_loadings <- as_tibble(pca_result$rotation, rownames = "gene")
  
  #Get top 10 genes by PCs
  top_genes <- pc_loadings %>% 
    # Select the PCs of interest
    dplyr::select(gene, PC1, PC2) %>%
    pivot_longer(matches("PC"), names_to = "PC", values_to = "loading") %>% 
    group_by(PC) %>% 
    arrange(desc(abs(loading))) %>%
    # take the 10 top rows
    slice(1:10) %>% 
    # pull the gene column as a vector
    dplyr::pull(gene) %>% 
    # ensure only unique genes are retained
    unique()
  
  #Convert Ensemble_gene_id to gene symbol
  ID_convert <- function(x){
    
    ensembl <- useMart("ensembl",dataset="hsapiens_gene_ensembl")
    
    getBM(filters="ensembl_gene_id", attributes="hgnc_symbol", values=x, mart=ensembl)
  }
  
  temp <- 0
  #Remove the version at the end of the Ensemble ID
  for (i in 1:length(top_genes)) {
      temp[i] <- unlist(strsplit(top_genes[i], "\\."))[1]
  }
  
  genes <- ID_convert(temp)
  
  write.table(genes, paste0(output_subdir, comparison, "Top_genes_by_PCs"), row.names = FALSE, col.names = FALSE, quote = FALSE, sep = "\n")
}

for (i in 1:10) {
  make_pca(i)
}

#Example
df <- read.csv("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/DESEQ2/Degrade_33_8vs24hr/33(8vs24hr)/deseq2_normalized_counts.csv")

rownames(df) <- df[, 1]
  
matrix_data <- as.matrix(df[, -1])

# Perform the PCA
pca_result <- prcomp(t(matrix_data))

# Create autoplot with loadings for the top feature
autoplot(pca_result, data = pc_scores, colour = 'Sample', label = TRUE, shape = FALSE, label.size = 3, loadings = TRUE, loadings.label = TRUE, scale = 0)

autoplot(pca_result, data = pc_scores, colour = 'Sample', label = TRUE, shape = FALSE, label.size = 3, loadings = TRUE, loadings.label = TRUE, scale = 0, loadings = TRUE, loadings.colour = 'blue', loadings.label = TRUE, loadings.label.size = 3)
```
WGCNA
```{r}
#WGCNA
#BiocManager::install("WGCNA")
library(rlang, lib = "/projectnb/tcwlab/LabMember/mwu/R/")
library(WGCNA, lib = "/projectnb/tcwlab/LabMember/mwu/R/")
library(flashClust)
library(curl)


plot_WGCNA_threshold <- function(x) {
  comparison <- deseq2_conf_list[x]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "deseq2_normalized_counts.csv"))
  
  outdir <- "/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/WGCNA"
  
  #Transpose the data
  t_df <- as.data.frame(t(df[, -1]))
  colnames(t_df) <- rownames(df)
  
  #Quality QC, default settings are used here
  gsg <-goodSamplesGenes(t_df)
  
  file_dir <- paste0("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/WGCNA/", comparison, "/")
  if(!file.exists(file_dir)) {
        dir.create(file_dir, mode="0755", recursive=TRUE)
  }
  
  write.csv(summary(gsg), paste0(file_dir, comparison, "_QC_summary.csv"))
  
  #Cluster samples based on distance
  sampleTree <- hclust(dist(t_df), method = "average")

  #Save as pdf
  pdf(paste0(file_dir, comparison, "_sample_cluster.pdf"), height = 10, width = 10)
  print(plot(sampleTree, main = paste0(comparison, " Sample Clusters"), sub="", xlab=""))
  dev.off()
  
  #Calculates networks from multiple soft threshold values
  spt <- pickSoftThreshold(t_df)
  
  #Plot the R^2 as a function of soft threshold
  sft_r2 <- ggplot(spt$fitIndices, aes(x = Power, y = SFT.R.sq, label = Power)) + 
  geom_hline(yintercept = 0.8, colour = "red") +
  geom_text(colour = "red") +
  labs(title = paste0(comparison, " Scale independence"), x = "Soft Threshold (power)", y = "Scale Free Topology Model Fit,signed R^2")
  
  #Save as pdf
  pdf(paste0(file_dir, comparison, "_soft_scale.pdf"), height = 10, width = 10)
  print(sft_r2)
  dev.off()
  
  #Plot mean connectivity as a function of soft threshold
  sft_k <- ggplot(spt$fitIndices, aes(x = Power, y = mean.k., label = Power)) + 
  geom_text(colour = "red") +
  labs(title = paste0(comparison, " Mean connectivity"), x = "Soft Threshold (power)", y = "Mean Connectivity")
  
  #Save as pdf
  pdf(paste0(file_dir, comparison, "_mean_connectivity.pdf"), height = 10, width = 10)
  print(sft_k)
  dev.off()
}

for (i in 2:10) {
  plot_WGCNA_threshold(i)
}


wgcna_dendro <- function(x) {
  comparison <- deseq2_conf_list[x]
  dir <- paste0(deseq2_root, comparison)
  subdir <- list.dirs(dir)[2]
  df <- read.csv(paste0(subdir, "/", "deseq2_normalized_counts.csv"))
  
  #Transpose the data
  t_df <- as.data.frame(t(df[, -1]))
  colnames(t_df) <- rownames(df)
  
  outdir <- "/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/WGCNA"
  
  softPower <- sft_list[i]
  adjacency <- adjacency(t_df, power = softPower)
  
  #Create the Topological Dissimilarity Matrix
  TOM.dissimilarity <- 1-TOMsimilarity(adjacency)
  
  #Cluster the dissimilarity matrix
  geneTree <- hclust(as.dist(TOM.dissimilarity), method = "average")
  
  file_dir <- paste0("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/output/WGCNA/", comparison, "/")
  
  #Plot dendrogram
  pdf(paste0(file_dir, comparison, "_dendrogram.pdf"), height = 10, width = 10)
  print(plot(geneTree, xlab="", sub="", main = "Gene clustering on TOM-based dissimilarity", 
labels = FALSE, hang = 0.04))
  dev.off()
  
  #To identify modules
  Modules <- cutreeDynamic(dendro = geneTree, distM = TOM.dissimilarity, deepSplit = 2, pamRespectsDendro = FALSE, minClusterSize = 30)
  #Assign colors to each module
  ModuleColors <- labels2colors(Modules)
  
  #Plot dendrogram
  pdf(paste0(file_dir, comparison, "_module_dendrogram.pdf"), height = 10, width = 10)
  print(plotDendroAndColors(geneTree, ModuleColors,"Module",
  dendroLabels = FALSE, hang = 0.03,
  addGuide = TRUE, guideHang = 0.05,
  main = "Gene dendrogram and module colors"))
  dev.off()
  
  #Identify eigengenes
  MElist <- moduleEigengenes(expression.data, colors = ModuleColors) 
  MEs <- MElist$eigengenes 
  
  write.csv(MEs, paste0(file_dir, comparison, "_eigengenes.csv"))
}


df <- read.csv("/projectnb/tcwlab/LabMember/mwu/Project/Astrocyte_Ab/2X100/results/DESEQ2/Degrade_33_8vs24hr/33(8vs24hr)/deseq2_normalized_counts.csv")

sft_list <- c(14, 14, 14, 14, 16, 18, 18, 14, 14, 12)

t_df <- as.data.frame(t(df[, -1]))
colnames(t_df) <- rownames(df)

#Build the adjacency matrix
softPower <- 14
adjacency <- adjacency(t_df, power = softPower)

TOM_astro <-  blockwiseModules(t_df, maxBlockSize=10000, minBlockSize=0, minModuleSize=30,
                                 corType="bicor", maxPOutliers=0.10, pearsonFallback="individual",
                                 power=14, networkType="signed", TOMType="signed", reassignThreshold=1E-8,
                                 mergeCutHeight=0.3, deepsplit=2, numericLabels=TRUE, verbose=4)

#Create the Topological Dissimilarity Matrix
TOM.dissimilarity <- 1-TOMsimilarity(adjacency)

#Cluster the dissimilarity matrix
geneTree <- hclust(as.dist(TOM.dissimilarity), method = "average") 

#Plot dendrogram
plot(geneTree, xlab="", sub="", main = "Gene clustering on TOM-based dissimilarity", 
labels = FALSE, hang = 0.04)

#To identify modules
Modules <- cutreeDynamic(dendro = geneTree, distM = TOM.dissimilarity, deepSplit = 2, pamRespectsDendro = FALSE, minClusterSize = 30)
#Assign colors to each module
ModuleColors <- labels2colors(Modules)

#Plot dendrogram
plotDendroAndColors(geneTree, ModuleColors,"Module",
dendroLabels = FALSE, hang = 0.03,
addGuide = TRUE, guideHang = 0.05,
main = "Gene dendrogram and module colors")

#Identify eigengenes
MElist <- moduleEigengenes(expression.data, colors = ModuleColors) 
MEs <- MElist$eigengenes 

for (i in 1:10) {
  wgcna_dendro(i)
}
```

```{r}


```